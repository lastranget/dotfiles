# List of plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'

set -g @plugin 'tmux-plugins/tmux-sessionist'
set -g @plugin 'tmux-plugins/tmux-resurrect'

# Other examples:
# set -g @plugin 'github_username/plugin_name'
# set -g @plugin 'github_username/plugin_name#branch'
# set -g @plugin 'git@github.com:user/plugin'
# set -g @plugin 'git@bitbucket.com:user/plugin'


set -g default-terminal "xterm-kitty"                                                                    
set -g terminal-overrides "xterm-kitty"                                                                                             

# set extended keys for nvim repeatable command
set -s extended-keys on
set -as terminal-features 'xterm*:extkeys'

# setup vim-tmux navigator
# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
# Note: we did this manually so that we could set the -Z flag
vim_pattern='(\S+/)?g?\.?(view|l?n?vim?x?|fzf)(diff)?(-wrapped)?'
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +${vim_pattern}$'"
bind-key -n 'C-h' if-shell "$is_vim" 'send-keys C-h'  'select-pane -L -Z'
bind-key -n 'C-j' if-shell "$is_vim" 'send-keys C-j'  'select-pane -D -Z'
bind-key -n 'C-k' if-shell "$is_vim" 'send-keys C-k'  'select-pane -U -Z'
bind-key -n 'C-l' if-shell "$is_vim" 'send-keys C-l'  'select-pane -R -Z'
tmux_version='$(tmux -V | sed -En "s/^tmux ([0-9]+(.[0-9]+)?).*/\1/p")'
if-shell -b '[ "$(echo "$tmux_version < 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\'  'select-pane -l -Z'"
if-shell -b '[ "$(echo "$tmux_version >= 3.0" | bc)" = 1 ]' \
    "bind-key -n 'C-\\' if-shell \"$is_vim\" 'send-keys C-\\\\'  'select-pane -l -Z'"

bind-key -T copy-mode-vi 'C-h' select-pane -L -Z
bind-key -T copy-mode-vi 'C-j' select-pane -D -Z
bind-key -T copy-mode-vi 'C-k' select-pane -U -Z
bind-key -T copy-mode-vi 'C-l' select-pane -R -Z
bind-key -T copy-mode-vi 'C-\' select-pane -l -Z

# Bind a key to open scrollback in $EDITOR (pipe copy mode to neovim)
bind-key v run-shell 'tmux capture-pane -peS -32768 > /tmp/tmux-buffer.out && tmux new-window "nvim +$ /tmp/tmux-buffer.out"'

# set thicker tmux pane line for visibility
set -g pane-border-lines heavy
# set-option -g pane-border-style 'fg=#596763' #match everforest dark

# set vi keybindings for copy mode
setw -g mode-keys vi

# copy tmux buffer to clipboard
set -s set-clipboard on
bind -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# set -ga terminal-overrides ",*256col*:Tc"                                                                              
set -ga terminal-overrides ",xterm-256color:Tc"                                                                         
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'                                                   
# underscore colours - needs tmux-3.0                                                                                               
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'
# trying to get clipboard passthrough to work
set -s set-clipboard on
set -as terminal-features ',xterm-kitty:clipboard'

# tmux everforest theme
  # from https://github.com/TanglingTreats/tmux-everforest/blob/main/tmux-everforest-light-medium.conf
  ## COLORSCHEME: everforest light medium
  set -g @everforest_bg_dim '#efebd4'
  # using everforest hard background to match kitty transparency
  set -g @everforest_bg0 '#fffbef'
  set -g @everforest_bg1 '#f6f0d9'
  set -g @everforest_bg2 '#efebd4'
  set -g @everforest_bg3 '#e6e2cc'
  set -g @everforest_bg4 '#e0dcc7'
  set -g @everforest_bg5 '#bdc3af'
  set -g @everforest_bg_visual '#eaedc8'
  set -g @everforest_bg_red '#fbe3da'
  set -g @everforest_bg_green '#f0f1d2'
  set -g @everforest_bg_blue '#e9f0e9'
  set -g @everforest_bg_yellow '#faedcd'

  set -g @everforest_fg '#5c6a72'
  set -g @everforest_red '#f85552'
  set -g @everforest_orange '#f57d26'
  set -g @everforest_yellow '#dfa000'
  set -g @everforest_green '#8da101'
  set -g @everforest_aqua '#35a77c'
  set -g @everforest_blue '#3a94c5'
  set -g @everforest_purple '#df69ba'
  set -g @everforest_grey0 '#a6b0a0'
  set -g @everforest_grey1 '#939f91'
  set -g @everforest_grey2 '#829181'
  set -g @everforest_statusline1 '#93b259'
  set -g @everforest_statusline2 '#708089'
  set -g @everforest_statusline3 '#e66868'

  set -g @halfway_green '#c1c96d'

# === TRANSPARENT STATUS BAR CONFIG ===
# Replace your existing theme/formatting section with this

set-option -g status "on"
set -g status-interval 2

# Main status bar - transparent background
set-option -g status-style fg='#{@everforest_fg}',bg=default

# ---- Windows ----
# Default window title - transparent
set-window-option -g window-status-style fg='#{@everforest_grey1}',bg=default

# Window with activity alert
set-window-option -g window-status-activity-style fg='#{@everforest_orange}',bg=default

# Active window - transparent with bold highlight
set-window-option -g window-status-current-style fg='#{@everforest_green}',bg=default,bold

# ---- Pane ----
# pane borders (these can stay as-is, but here for completeness)
set-option -g pane-border-style fg='#{@everforest_bg3}'
set-option -g pane-active-border-style fg='#{@everforest_blue}'

# ---- Command/Message ----
# message info - keeping a subtle background so you can read it
set-option -g message-style fg='#{@everforest_statusline3}',bg='#{@everforest_bg_dim}'
set-option -g message-command-style fg='#{@everforest_fg}',bg='#{@everforest_bg1}'

# ---- Clock ----
set-window-option -g clock-mode-colour '#{@everforest_blue}'

# ---- Bell ----
set-window-option -g window-status-bell-style fg='#{@everforest_red}',bg='#{@everforest_bg0}',bold

# ---- Formatting ----
set-option -g status-left-style none
set -g status-left-length 60
set -g status-left '#[fg=#{@everforest_green},bg=#{@everforest_bg0}]█'
set -ga status-left '#[fg=#{@everforest_green},bg=#{@everforest_bg0},reverse,bold] TMUX'
set -ga status-left '#[fg=#{@halfway_green},bg=#{@everforest_green}]'
set -ga status-left '#[fg=#{@everforest_bg2},bg=#{@halfway_green}]'
set -ga status-left '#[fg=#{@everforest_bg2},bg=#{@everforest_fg},bold] #S '
set -ga status-left '#[fg=#{@everforest_bg0},bg=#{@everforest_bg2}] '

set-option -g status-right-style none
set -g status-right-length 150
set -g status-right '#[fg=#{@everforest_grey1}]#(ss -lx | grep -c nvim) vim │ #(free | awk "/Mem:/{printf \"%.0f\", \$3/\$2*100}")%% mem │ #(awk "{printf \"%.0f\", \$1*100}" /proc/loadavg)%% cpu #[fg=#{@everforest_aqua},bold]│ #h '

set -g window-status-separator '#[fg=#{@everforest_grey2}] │ '
set -g window-status-format "#[fg=#{@everforest_grey1}]#I:#W#{?window_zoomed_flag, z,  }"
set -g window-status-current-format "#[fg=#{@everforest_green},bold]#I:#W#[fg=#{@everforest_aqua}]*#{?window_zoomed_flag,z, }"
# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
